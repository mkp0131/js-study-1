<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ì§€ë¢°ì°¾ê¸°</title>
</head>
<body>
	<style>
		table {
			border: 1px solid #dbdbdb;
		}
		table td {
			width: 30px;
			height: 30px;
			border: 1px solid #dbdbdb;
			background: #bdbdbd;
			text-align: center;
			cursor: pointer;
		}
		table td.open {
			background: #fafafa;
		}
		
		.timer {
			font-size: 32px;
			font-weight: 700;
		}
		.flag {
			font-size: 28px;
			font-weight: 700;
		}
		.lose-msg {
			position: fixed;
			left: 20px;
			top: 50px;
			background: #fafafa;
			border-radius: 50px;
			overflow: hidden;
			padding: 10px 30px;
			cursor: pointer;
		}

		.lose-msg:hover {
			opacity: 0.1;
		}
		.complete table {
			pointer-events: none;
		}
		.complete table td {
			background: #444;
		}
		.complete table td.open {
			background: #bdbdbd;
		}
	</style>

	<form onsubmit="gameInit();">
		ê°€ë¡œ: <input type="text" name="hor" class="js-game-hor" value="10" />
		ì„¸ë¡œ: <input type="text" name="ver" class="js-game-ver" value="10" />
		ì§€ë¢°: <input type="text" name="mine" class="js-game-mine" value="20" />
		<button type="submit">ìƒì„±</button>
	</form>
	<hr />
	<div class="js-game-borad"></div>

	<script>
		let madeGame = false;
		const gameInit = () => {
			// ì„œë¸Œë°‹ ë°©ì§€
			event.preventDefault();

			// ê²Œì„ì¤‘ë³µìƒì„±ë°©ì§€
			const gameBoardElement = document.querySelector('.js-game-borad');
			gameBoardElement.innerHTML = '';
			if(gameBoardElement.classList.contains('complete')) {
				gameBoardElement.classList.remove('complete');
			}

			// input value ê°€ì ¸ì˜¤ê¸°
			const gameHor = parseInt(document.querySelector('.js-game-hor').value);
			const gameVer = parseInt(document.querySelector('.js-game-ver').value);
			const gameMine = parseInt(document.querySelector('.js-game-mine').value);
	
			// ê²Œì„ë°ì´í„° ìƒì„± (1: ì•ˆì „, 2: ì§€ë¢°)
			let gameBoard = [];
			for (let index = 0; index < gameVer; index++) {
				let gameBoardRow = Array(gameHor).fill().map(item => 1);
				gameBoard.push(gameBoardRow);
			}

			// ì§€ë¢°ìƒì„±
			let gameBoardRange = gameHor * gameVer;
			let gameBoardMineNumbers = [];
			let gameBoardNumbers = Array(gameBoardRange).fill().map((item, index) => index + 1);
			while (gameBoardNumbers.length > gameBoardRange - gameMine) {
				gameBoardMineNumbers.push(gameBoardNumbers.splice(Math.random() * gameBoardNumbers.length, 1)[0]);
			}
			gameBoardMineNumbers.sort((a,b) => a - b);

			// ê²Œì„ë³´ë“œ ìƒì„±
			const table = document.createElement('table');
			table.classList.add('js-game-board');
			gameBoard.forEach((row, rowIndex) => {
				const tr = document.createElement('tr');
				row.forEach((ver, verIndex) => {
					const td = document.createElement('td');
					td.dataset.no = (rowIndex * gameHor) + (verIndex + 1);
					td.dataset.flag = "false";
					tr.appendChild(td);
				})
				table.appendChild(tr);
			});
			gameBoardElement.appendChild(table);

			// ê²Œì„ë³´ë“œì— ì§€ë¢° ì‹¬ê¸° & ê²Œì„ë°ì´í„°ì— ì§€ë¢° ë„£ê¸°
			gameBoardMineNumbers.forEach(num => {
				const target = document.querySelector(`.js-game-board td[data-no="${num}"]`);
				target.innerHTML = 'ğŸ’£';
				const mineRow = Math.floor((num - 1) / gameHor);
				const mineCol = (num - 1) % gameHor;
				gameBoard[mineRow][mineCol] = 2;
			});



			// íƒ€ì´ë¨¸ ë§Œë“¤ê¸°
			function addZeroForSingleDigit(digit) {
				let result = digit;
				if(digit < 10) {
					result = '0' + digit;
				}
				return result;
			}
			const timer = document.createElement('div');
			timer.classList.add('timer');
			let timerSecond = 0;
			timer.innerHTML = "00:00";
			const setTimer = setInterval(() => {
				timerSecond++;
				timer.innerHTML = addZeroForSingleDigit(Math.floor(timerSecond / 60)) + ":" + addZeroForSingleDigit(timerSecond % 60);
			}, 1000);
			gameBoardElement.appendChild(timer);

			// ê¹ƒë°œ ê°¯ìˆ˜ ì¹´ìš´íŠ¸
			let LimitFlag = gameMine;
			const LimitFlagElement = document.createElement('div');
			LimitFlagElement.classList.add('flag');
			function flagElementReflash(limit) {
				LimitFlagElement.innerHTML = `ğŸš© ${limit}`;
			}
			gameBoardElement.appendChild(LimitFlagElement);
			flagElementReflash(LimitFlag);

			// ìš°í´ë¦­ ê¹ƒë°œ ìƒì„± ì´ë²¤íŠ¸ë¦¬ìŠ¤ë„ˆ
			let mineFlagNumbers = [];
			table.addEventListener('contextmenu', function(e) {
				e.preventDefault();

				function checkMineFlag(targetNo) {
					const findIndex = mineFlagNumbers.indexOf(targetNo);
					if(findIndex > -1) {
						mineFlagNumbers.splice(findIndex, 1);
						LimitFlag++;
						flagElementReflash(LimitFlag);
					}
				}

				const targetNo = e.target.dataset.no;
				if(!targetNo) return;
				if(e.target.dataset.flag === "false") {
					if(LimitFlag <= 0) return; // flag ì†Œì§„ì‹œ ì‹¤í–‰ë°©ì§€
					e.target.dataset.flag = "true";
					e.target.innerHTML = 'ğŸš©';
					mineFlagNumbers.push(targetNo);
					LimitFlag--;
					flagElementReflash(LimitFlag);
				}
				else if(e.target.dataset.flag === "true") {
					e.target.innerHTML = 'â“';
					checkMineFlag(targetNo);
					e.target.dataset.flag = "mark";
				}
				else {
					e.target.innerHTML = '';
					checkMineFlag(targetNo);
					e.target.dataset.flag = "false";
				}
			});

			// ì—´ë¦° ì¹¸ ì¹´ìš´íŠ¸
			let openBoxCnt = 0;
			// ê²°ê³¼ë©”ì„¸ì§€ í•¨ìˆ˜
			function alertMsg(msg) {
				const loseMsg = document.createElement('h1');
				loseMsg.classList.add('lose-msg')
				loseMsg.innerHTML = msg;
				gameBoardElement.appendChild(loseMsg);
				gameBoardElement.classList.add('complete');
				clearInterval(setTimer);
			}
			// ì¹¸ì„ í´ë¦­í–ˆì„ë•Œ
			table.addEventListener('click', function(e) {
				const targetNo = e.target.dataset.no;
				if(!targetNo) return; // ì™¸ë¶€ì˜ì—­ í´ë¦­ë°©ì§€
				const targetFlag = e.target.dataset.flag;
				if(targetFlag !== "false") return; // ë¬¼ìŒí‘œ, ëŠë‚Œí‘œ ìˆì„ì‹œ í´ë¦­ë°©ì§€ 

				const mineRow = Math.floor((targetNo - 1) / gameHor);
				const mineCol = (targetNo - 1) % gameHor;
				const target = e.target;
				target.classList.add('open');
				openBoxCnt++;
				if(openBoxCnt === gameHor * gameVer - gameMine) {
					alertMsg('You are Win ğŸ˜ƒ');
				}

				console.log('openBoxCnt', openBoxCnt);
				if(gameBoard[mineRow][mineCol] === 2) {
					target.innerHTML = 'ğŸ’¥';
					alertMsg('You are lose ğŸ¥µ');
				}
				else {
					// #ì²´í¬ë²”ìœ„
					let checkRange = [];
					// ìœ„
					if(mineRow - 1 >= 0) {
						checkRange.push([gameBoard[mineRow - 1][mineCol], (mineRow - 1) * gameHor + mineCol]);
					}
					// ì•„ë˜
					if(mineRow + 1 < gameVer) {
						checkRange.push([gameBoard[mineRow + 1][mineCol], (mineRow + 1) * gameHor + mineCol]);
					}
					// ì™¼ìª½
					if(mineCol - 1 >= 0) {
						checkRange.push([gameBoard[mineRow][mineCol - 1], mineRow * gameHor + mineCol - 1]);
					}
					// ì˜¤ë¥¸ìª½
					if(mineCol + 1 < gameHor) {
						checkRange.push([gameBoard[mineRow][mineCol + 1], mineRow * gameHor + mineCol + 1]);
					}
					// ìœ„,ì™¼ìª½
					if(mineRow - 1 >= 0 && mineCol - 1 >= 0) {
						checkRange.push([gameBoard[mineRow - 1][mineCol - 1], (mineRow - 1) * gameHor + mineCol - 1]);
					}
					// ìœ„,ì˜¤ë¥¸ìª½
					if(mineRow - 1 >= 0 && mineCol + 1 < gameHor) {
						checkRange.push([gameBoard[mineRow - 1][mineCol + 1], (mineRow - 1) * gameHor + mineCol + 1]);
					}
					// ì•„ë˜,ì™¼ìª½
					if(mineRow + 1 < gameVer && mineCol - 1 >= 0) {
						checkRange.push([gameBoard[mineRow + 1][mineCol - 1], (mineRow + 1) * gameHor + mineCol - 1]);
					}
					// ì•„ë˜,ì˜¤ë¥¸ìª½
					if(mineRow + 1 < gameVer && mineCol + 1 < gameHor) {
						checkRange.push([gameBoard[mineRow + 1][mineCol + 1], (mineRow + 1) * gameHor + mineCol + 1]);
					}
					// #ì²´í¬ë²”ìœ„ì— Mineì²´í¬
					const checkRangeResult = checkRange.filter(mine => mine[0] === 2).length;
					target.innerHTML = (checkRangeResult) ? checkRangeResult : '';
					// #í´ë¦­í•œ ë²”ìœ„ê°€ 0ì´ë©´ ì£¼ë³€ì— ìˆ«ìê°€ ë‚˜ì˜¬ë•Œê¹Œì§€ opení•˜ê¸°
					if(checkRangeResult === 0) {
						checkRange.forEach(checkTarget => {
							const dataNo = parseInt(checkTarget[1]) + 1;
							const clickTarget = document.querySelector(`.js-game-board td[data-no="${dataNo}"]`);
							if(!clickTarget.classList.contains('open')) {
								clickTarget.click();
							}
						});
					}
				}
			});

		}
	</script>
</body>
</html>